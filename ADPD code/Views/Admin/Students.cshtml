@model IEnumerable<ADPD_code.Models.Student>
@{
    var isPartial = ViewData["IsPartial"] as bool? ?? false;
    Layout = isPartial ? null : "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/AdminDashboard.css?v=1.0" rel="stylesheet" asp-append-version="true" />

<div class="management-wrapper">
    <div class="management-header">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div>
                <h1>
                    <span>üéì</span>
                    Qu·∫£n l√Ω Sinh vi√™n
                </h1>
                <p>Th√™m, s·ª≠a, x√≥a th√¥ng tin sinh vi√™n</p>
            </div>
            <a href="@Url.Action("Dashboard", "Admin")" 
               class="btn btn-secondary" 
               style="padding: 10px 20px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;"
               data-partial-url="@Url.Action("Dashboard", "Admin", new { partial = true })">
                ‚Üê V·ªÅ Dashboard
            </a>
        </div>
    </div>

    <div class="management-toolbar">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo t√™n, MSSV, email...">
        </div>
        <button type="button" class="btn btn-primary" onclick="showCreateModal()">
            ‚ûï Th√™m sinh vi√™n
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>MSSV</th>
                    <th>H·ªç v√† t√™n</th>
                    <th>Email</th>
                    <th>SƒêT</th>
                    <th>L·ªõp</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                @{
                    int index = 1;
                }
                @foreach (var student in Model)
                {
                    var className = student.StudentClasses?.FirstOrDefault()?.Class?.ClassName ?? "N/A";
                    <tr>
                        <td>@index</td>
                        <td><strong>@student.StudentId.ToString().PadLeft(10, '0')</strong></td>
                        <td>@student.FullName</td>
                        <td>@student.Email</td>
                        <td>@student.Phone</td>
                        <td>@className</td>
                        <td>
                            <span class="status-badge @(student.Status == "ƒêang h·ªçc" ? "status-active" : "status-inactive")">
                                @student.Status
                            </span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-success" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="editStudent(@student.StudentId)">‚úèÔ∏è S·ª≠a</button>
                            <button type="button" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteStudent(@student.StudentId)">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>
                    index++;
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Th√™m/S·ª≠a Sinh vi√™n -->
<div id="studentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Th√™m Sinh vi√™n</h2>
            <button type="button" class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <form id="studentForm">
            <div class="modal-body">
                <input type="hidden" id="studentId" name="StudentId" />
                <div class="form-group">
                    <label>H·ªç v√† t√™n *</label>
                    <input type="text" id="fullName" name="FullName" required />
                </div>
                <div class="form-group">
                    <label>Gi·ªõi t√≠nh *</label>
                    <select id="gender" name="Gender" required>
                        <option value="">-- Ch·ªçn --</option>
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ng√†y sinh *</label>
                    <input type="date" id="dob" name="DOB" required />
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="email" name="Email" required />
                </div>
                <div class="form-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                    <input type="tel" id="phone" name="Phone" required />
                </div>
                <div class="form-group">
                    <label>ƒê·ªãa ch·ªâ *</label>
                    <input type="text" id="address" name="Address" required />
                </div>
                <div class="form-group">
                    <label>Tr·∫°ng th√°i *</label>
                    <select id="status" name="Status" required>
                        <option value="ƒêang h·ªçc">ƒêang h·ªçc</option>
                        <option value="Ngh·ªâ h·ªçc">Ngh·ªâ h·ªçc</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>L·ªõp</label>
                    <select id="classId" name="ClassID">
                        <option value="">-- Ch·ªçn l·ªõp --</option>
                        @if (ViewBag.Classes != null)
                        {
                            @foreach (var cls in ViewBag.Classes)
                            {
                                <option value="@cls.ClassID">@cls.ClassName</option>
                            }
                        }
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal()" style="background: #6c757d; color: white;">H·ªßy</button>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
            </div>
        </form>
    </div>
</div>

<script>
    // ƒê·∫£m b·∫£o c√°c h√†m ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ngay l·∫≠p t·ª©c (IIFE)
    (function() {
        'use strict';
        
        // ƒê·∫£m b·∫£o c√°c h√†m ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong scope global
        window.showCreateModal = function() {
        console.log('showCreateModal called');
        const modal = document.getElementById('studentModal');
        const form = document.getElementById('studentForm');
        const title = document.getElementById('modalTitle');
        const studentId = document.getElementById('studentId');
        
        if (!modal || !form || !title || !studentId) {
            console.error('Modal elements not found');
            alert('C√≥ l·ªói x·∫£y ra khi m·ªü form!');
            return;
        }
        
        title.textContent = 'Th√™m Sinh vi√™n';
        form.reset();
        studentId.value = '';
        modal.style.display = 'block';
        
        // Re-attach form handler sau khi modal hi·ªÉn th·ªã
        setTimeout(initFormHandlers, 100);
    };

    window.editStudent = function(id) {
        console.log('editStudent called with id:', id);
        fetch(`/Admin/EditStudent/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Edit response:', data);
                if (data.success && data.student) {
                    fillEditForm(data.student);
                } else {
                    alert('‚ùå ' + (data.message || 'Kh√¥ng t√¨m th·∫•y sinh vi√™n'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin sinh vi√™n!');
            });
    };

    function fillEditForm(student) {
        const modal = document.getElementById('studentModal');
        const title = document.getElementById('modalTitle');
        
        if (!modal || !title) {
            console.error('Modal elements not found');
            return;
        }
        
        title.textContent = 'S·ª≠a Sinh vi√™n';
        document.getElementById('studentId').value = student.StudentId;
        document.getElementById('fullName').value = student.FullName || '';
        document.getElementById('gender').value = student.Gender || '';
        document.getElementById('dob').value = student.DOB || '';
        document.getElementById('email').value = student.Email || '';
        document.getElementById('phone').value = student.Phone || '';
        document.getElementById('address').value = student.Address || '';
        document.getElementById('status').value = student.Status || '';
        if (student.ClassID) {
            document.getElementById('classId').value = student.ClassID;
        }
        modal.style.display = 'block';
        
        // Re-attach form handler sau khi modal hi·ªÉn th·ªã
        setTimeout(initFormHandlers, 100);
    }

    window.deleteStudent = function(id) {
        console.log('deleteStudent called with id:', id);
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a sinh vi√™n n√†y?')) {
            return;
        }

        fetch(`/Admin/DeleteStudent/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Delete response:', data);
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    location.reload();
                } else {
                    alert('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a sinh vi√™n: ' + error.message);
            });
    };

    window.closeModal = function() {
        const modal = document.getElementById('studentModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };

    // ƒê·∫£m b·∫£o DOM ƒë√£ s·∫µn s√†ng tr∆∞·ªõc khi attach event listeners
    function initFormHandlers() {
        const form = document.getElementById('studentForm');
        if (form) {
            // Ki·ªÉm tra xem ƒë√£ c√≥ event listener ch∆∞a
            if (form.dataset.listenerAttached === 'true') {
                return; // ƒê√£ c√≥ listener r·ªìi, kh√¥ng c·∫ßn attach l·∫°i
            }
            
            // Attach event listener
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Form submit triggered');
                
                const formData = new FormData(this);
                const studentId = document.getElementById('studentId')?.value || '';
                const classId = document.getElementById('classId')?.value || '';
                
                // Validate form
                const fullName = formData.get('FullName');
                const email = formData.get('Email');
                const dob = formData.get('DOB');
                
                if (!fullName || !email || !dob) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (H·ªç t√™n, Email, Ng√†y sinh)!');
                    return false;
                }

                const data = {
                    FullName: fullName,
                    Gender: formData.get('Gender') || 'Nam',
                    DOB: dob,
                    Email: email,
                    Phone: formData.get('Phone') || '',
                    Address: formData.get('Address') || '',
                    Status: formData.get('Status') || 'ƒêang h·ªçc',
                    ClassID: classId && classId !== '' ? parseInt(classId) : null
                };

                let url = '/Admin/CreateStudent';
                
                if (studentId && studentId !== '' && studentId !== '0') {
                    url = `/Admin/EditStudent/${parseInt(studentId)}`;
                    data.StudentId = parseInt(studentId);
                } else {
                    // ƒê·∫£m b·∫£o kh√¥ng c√≥ StudentId khi t·∫°o m·ªõi
                    if (data.StudentId !== undefined) {
                        delete data.StudentId;
                    }
                }

                const jsonBody = JSON.stringify(data);
                
                console.log('Sending data:', data);
                console.log('URL:', url);
                console.log('JSON string:', jsonBody);
                console.log('Body length:', jsonBody.length);

                if (!jsonBody || jsonBody === '{}') {
                    alert('L·ªói: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!');
                    return false;
                }

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: jsonBody
                })
                    .then(response => {
                        console.log('Response status:', response.status);
                        console.log('Response headers:', response.headers);
                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error('Error response:', text);
                                throw new Error(`HTTP ${response.status}: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response data:', data);
                        if (data.success) {
                            alert('‚úÖ ' + data.message);
                            closeModal();
                            setTimeout(() => {
                                location.reload();
                            }, 500);
                        } else {
                            alert('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                    });
                
                return false;
            });
            
            // ƒê√°nh d·∫•u ƒë√£ attach listener
            form.dataset.listenerAttached = 'true';
        }

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#studentTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('studentModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    }

        // Ch·∫°y ngay l·∫≠p t·ª©c khi script ƒë∆∞·ª£c load
        initFormHandlers();
        
        // Ch·∫°y l·∫°i sau m·ªôt kho·∫£ng th·ªùi gian ƒë·ªÉ ƒë·∫£m b·∫£o form ƒë√£ ƒë∆∞·ª£c render
        setTimeout(function() {
            initFormHandlers();
        }, 200);
        
        // C≈©ng ch·∫°y khi DOM s·∫µn s√†ng (fallback)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initFormHandlers, 100);
            });
        } else {
            // DOM ƒë√£ s·∫µn s√†ng, ch·∫°y ngay
            setTimeout(initFormHandlers, 100);
        }
    })();
</script>

<style>
    .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
</style>
