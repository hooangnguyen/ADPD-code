@model IEnumerable<ADPD_code.Models.Class>
@{
    var isPartial = ViewData["IsPartial"] as bool? ?? false;
    Layout = isPartial ? null : "~/Views/Shared/_Layout.cshtml";
    var stats = ViewBag.ClassManagerStats as ADPD_code.Patterns.ClassManagerStats;
}
<link href="~/css/AdminDashboard.css?v=1.0" rel="stylesheet" asp-append-version="true" />

<div class="management-wrapper">
    <!-- ‚≠ê SINGLETON PATTERN BANNER -->
    <div class="singleton-banner">
        <div class="singleton-header">
            <span class="singleton-icon">üî∑</span>
            <div>
                <h3>Singleton Pattern Demo</h3>
                <p>ClassManager - Centralized management of all class operations</p>
            </div>
        </div>
        <div class="singleton-stats">
            <div class="stat-item">
                <div class="stat-label">Total Operations</div>
                <div class="stat-value">@(stats?.TotalOperations ?? 0)</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Instance Hash</div>
                <div class="stat-value">@ViewBag.SingletonHashCode</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Uptime</div>
                <div class="stat-value">@(stats != null ? $"{stats.Uptime.TotalMinutes:F1}m" : "N/A")</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Status</div>
                <div class="stat-value status-active">@(stats?.IsActive == true ? "Active" : "Inactive")</div>
            </div>
        </div>
    </div>

    <div class="management-header">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div>
                <h1>
                    <span>üè´</span>
                    Class Management
                </h1>
                <p>Add, edit, delete class information</p>
            </div>
            <a href="@Url.Action("Dashboard", "Admin")"
               class="btn btn-secondary"
               style="padding: 10px 20px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;"
               data-partial-url="@Url.Action("Dashboard", "Admin", new { partial = true })">
                ‚Üê Back to Dashboard
            </a>
        </div>
    </div>

    <div class="management-toolbar">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Search by class name...">
        </div>
        <button type="button" class="btn btn-primary" onclick="showCreateModal()">
            ‚ûï Add Class
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Class ID</th>
                    <th>Class Name</th>
                    <th>Major</th>
                    <th>Study Date</th>
                    <th>Students</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="classTableBody">
                @{
                    int index = 1;
                }
                @foreach (var classModel in Model)
                {
                    <tr>
                        <td>@index</td>
                        <td><strong>@classModel.ClassID.ToString().PadLeft(5, '0')</strong></td>
                        <td>@classModel.ClassName</td>
                        <td>@(classModel.Major?.MajorName ?? "N/A")</td>
                        <td>@classModel.StudyTime.ToString("dd/MM/yyyy")</td>
                        <td>@(classModel.StudentClasses?.Count ?? 0)</td>
                        <td>
                            <button type="button" class="btn btn-success" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="editClass(@classModel.ClassID)">‚úèÔ∏è Edit</button>
                            <button type="button" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteClass(@classModel.ClassID)">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                    index++;
                }
            </tbody>
        </table>
    </div>

    <!-- ‚≠ê SINGLETON PATTERN EXPLANATION PANEL -->
    <div class="pattern-explanation">
        <h3>üìö About Singleton Pattern</h3>
        <div class="explanation-content">
            <div class="explanation-item">
                <strong>‚úÖ Single Instance Guarantee:</strong>
                <p>ClassManager has only one instance across the application (Hash: @ViewBag.SingletonHashCode)</p>
            </div>
            <div class="explanation-item">
                <strong>‚úÖ Centralized Management:</strong>
                <p>All Create, Read, Update, Delete operations are handled through ClassManager</p>
            </div>
            <div class="explanation-item">
                <strong>‚úÖ Automatic Logging:</strong>
                <p>Each operation is logged and counted (Total: @(stats?.TotalOperations ?? 0) operations)</p>
            </div>
            <div class="explanation-item">
                <strong>‚úÖ Thread-safe:</strong>
                <p>Uses double-check locking to ensure safety in multi-threaded environments</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Add/Edit Class -->
<div id="classModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Class</h2>
            <button type="button" class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <form id="classForm">
            <div class="modal-body">
                <input type="hidden" id="classId" name="ClassID" />
                <div class="form-group">
                    <label>Class Name *</label>
                    <input type="text" id="className" name="ClassName" required />
                </div>
                <div class="form-group">
                    <label>Major *</label>
                    <select id="majorId" name="MajorID" required>
                        <option value="">-- Select Major --</option>
                        @if (ViewBag.Majors != null)
                        {
                            @foreach (var major in ViewBag.Majors)
                            {
                                <option value="@major.MajorID">@major.MajorName</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Study Date *</label>
                    <input type="date" id="studyTime" name="StudyTime" required />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal()" style="background: #6c757d; color: white;">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* ‚≠ê SINGLETON BANNER STYLES */
    .singleton-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .singleton-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }

    .singleton-icon {
        font-size: 48px;
        line-height: 1;
    }

    .singleton-header h3 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
    }

    .singleton-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
    }

    .singleton-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        backdrop-filter: blur(10px);
    }

    .stat-item {
        text-align: center;
    }

    .stat-label {
        font-size: 12px;
        opacity: 0.8;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        font-family: 'Courier New', monospace;
    }

        .stat-value.status-active {
            color: #4ade80;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

    /* ‚≠ê PATTERN EXPLANATION STYLES */
    .pattern-explanation {
        background: #f8f9fa;
        border: 2px solid #667eea;
        border-radius: 12px;
        padding: 25px;
        margin-top: 30px;
    }

        .pattern-explanation h3 {
            color: #667eea;
            margin: 0 0 20px 0;
            font-size: 20px;
        }

    .explanation-content {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .explanation-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

        .explanation-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .explanation-item p {
            margin: 0;
            color: #666;
            font-size: 13px;
            line-height: 1.6;
        }

    /* Responsive */
    @@media (max-width: 768px) {
        .singleton-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .explanation-content {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    (function() {
        'use strict';

        console.log('%cüî∑ Singleton Pattern Active', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('ClassManager Instance Hash:', '@ViewBag.SingletonHashCode');
        console.log('Total Operations:', @(stats?.TotalOperations ?? 0));
        console.log('Uptime:', '@(stats != null ? $"{stats.Uptime.TotalMinutes:F1}" : "0")' + ' minutes');

        window.showCreateModal = function() {
            console.log('üî∑ Singleton: showCreateModal called');
            const modal = document.getElementById('classModal');
            const form = document.getElementById('classForm');
            const title = document.getElementById('modalTitle');
            const classId = document.getElementById('classId');

            if (!modal || !form || !title || !classId) {
                console.error('Modal elements not found');
                alert('Error opening form!');
                return;
            }

            title.textContent = 'Add Class';
            form.reset();
            classId.value = '';
            modal.style.display = 'block';
            setTimeout(initFormHandlers, 100);
        };

        window.editClass = function(id) {
            console.log('üî∑ Singleton: editClass called with id:', id);
            fetch(`/Admin/EditClass/${id}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('üî∑ Singleton: Edit response:', data);
                    if (data.success && data.classModel) fillEditForm(data.classModel);
                    else alert('‚ùå ' + (data.message || 'Class not found'));
                })
                .catch(error => { console.error('Error:', error); alert('Error loading class info: ' + error.message); });
        };

        function fillEditForm(classModel) {
            const modal = document.getElementById('classModal');
            const title = document.getElementById('modalTitle');

            if (!modal || !title) return;

            title.textContent = 'Edit Class';
            document.getElementById('classId').value = classModel.ClassID || '';
            document.getElementById('className').value = classModel.ClassName || '';
            document.getElementById('majorId').value = classModel.MajorID || '';
            document.getElementById('studyTime').value = classModel.StudyTime || '';

            modal.style.display = 'block';
        }

        window.deleteClass = function(id) {
            console.log('üî∑ Singleton: deleteClass called with id:', id);
            if (!confirm('Are you sure you want to delete this class?')) return;

            fetch(`/Admin/DeleteClass/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' } })
                .then(response => { if (!response.ok) return response.text().then(text => { throw new Error(`HTTP ${response.status}: ${text}`); }); return response.json(); })
                .then(data => { if (data.success) { alert('‚úÖ ' + data.message); location.reload(); } else alert('‚ùå ' + (data.message || 'Error occurred')); })
                .catch(error => { console.error('Error:', error); alert('Error deleting class: ' + error.message); });
        };

        window.closeModal = function() {
            const modal = document.getElementById('classModal');
            if (modal) modal.style.display = 'none';
        };

        function initFormHandlers() {
            const form = document.getElementById('classForm');

            if (form && form.dataset.listenerAttached !== 'true') {
                form.addEventListener('submit', handleFormSubmit);
                form.dataset.listenerAttached = 'true';
            }

            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.dataset.listenerAttached !== 'true') {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    document.querySelectorAll('#classTableBody tr').forEach(row => {
                        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                    });
                });
                searchInput.dataset.listenerAttached = 'true';
            }

            window.onclick = function(event) {
                const modal = document.getElementById('classModal');
                if (event.target === modal) closeModal();
            };
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            e.stopPropagation();

            console.log('üî∑ Singleton: Form submit triggered');

            const classId = document.getElementById('classId').value.trim();
            const className = document.getElementById('className').value.trim();
            const majorId = document.getElementById('majorId').value.trim();
            const studyTime = document.getElementById('studyTime').value.trim();

            if (!className) { alert('‚ùå Please enter Class Name'); return false; }
            if (!majorId) { alert('‚ùå Please select Major'); return false; }
            if (!studyTime) { alert('‚ùå Please select Study Date'); return false; }

            const data = { ClassName: className, MajorID: parseInt(majorId), StudyTime: studyTime };
            let url = '/Admin/CreateClass';

            if (classId && classId !== '0' && classId !== '') {
                url = `/Admin/EditClass/${classId}`;
                data.ClassID = parseInt(classId);
                console.log('üî∑ Singleton MODE: EDIT - Class ID:', classId);
            } else console.log('üî∑ Singleton MODE: CREATE');

            fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(data) })
                .then(response => { if (!response.ok) return response.text().then(text => { throw new Error(`HTTP ${response.status}: ${text}`); }); return response.json(); })
                .then(responseData => { if (responseData.success) { alert('‚úÖ ' + responseData.message); closeModal(); setTimeout(() => location.reload(), 500); } else alert('‚ùå ' + (responseData.message || 'Error occurred')); })
                .catch(error => { console.error('‚ùå Fetch error:', error); alert('‚ùå Error: ' + error.message); });

            return false;
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initFormHandlers);
        else initFormHandlers();
    })();
</script>
