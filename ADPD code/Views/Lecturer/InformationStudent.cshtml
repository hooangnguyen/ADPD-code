@{
    var isPartial = ViewData["IsPartial"] as bool? ?? false;
    Layout = isPartial ? null : "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/Information.css?v=2.0" asp-append-version="true" />

<div class="student-management-wrapper">
    <div class="container">
        <div class="header">
            <h1>
                <span style="font-size: 36px;">📚</span>
                Quản lý Sinh viên
            </h1>
            <p>Danh sách toàn bộ sinh viên đang được quản lý</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalStudents">0</h3>
                <p>Tổng số sinh viên</p>
            </div>
            <div class="stat-card">
                <h3 id="activeStudents">0</h3>
                <p>Đang học</p>
            </div>
            <div class="stat-card">
                <h3 id="avgAttendance">0%</h3>
                <p>Tỷ lệ tham dự TB</p>
            </div>
            <div class="stat-card">
                <h3 id="classCount">0</h3>
                <p>Số lớp</p>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên, MSSV, email...">
            </div>

            <select class="filter-select" id="classFilter">
                <option value="">Tất cả lớp</option>
                @if (ViewBag.Classes != null)
                {
                    @foreach (var className in ViewBag.Classes)
                    {
                        <option value="@className">@className</option>
                    }
                }
            </select>

            <select class="filter-select" id="statusFilter">
                <option value="">Tất cả trạng thái</option>
                <option value="Đang học">Đang học</option>
                <option value="Nghỉ học">Nghỉ học</option>
            </select>

            <button class="btn btn-excel" onclick="exportToExcel()">
                📊 Xuất Excel
            </button>
        </div>

        <div class="table-container">
            <table id="studentTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">STT</th>
                        <th onclick="sortTable(1)">Avatar</th>
                        <th onclick="sortTable(2)">MSSV ↕</th>
                        <th onclick="sortTable(3)">Họ và tên ↕</th>
                        <th onclick="sortTable(4)">Lớp ↕</th>
                        <th onclick="sortTable(5)">Email</th>
                        <th onclick="sortTable(6)">SĐT</th>
                        <th onclick="sortTable(7)">Điểm TB ↕</th>
                        <th onclick="sortTable(8)">Tỷ lệ tham dự ↕</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal hiển thị chi tiết sinh viên -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Thông tin chi tiết sinh viên</h2>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="student-detail">
                    <div class="student-photo" id="modalAvatar">SV</div>
                    <div class="student-info">
                        <div class="info-group">
                            <label>Mã số sinh viên</label>
                            <p id="modalMSSV">-</p>
                        </div>
                        <div class="info-group">
                            <label>Họ và tên</label>
                            <p id="modalName">-</p>
                        </div>
                        <div class="info-group">
                            <label>Lớp</label>
                            <p id="modalClass">-</p>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <div class="info-group">
                        <label>Ngày sinh</label>
                        <p id="modalDOB">-</p>
                    </div>
                    <div class="info-group">
                        <label>Giới tính</label>
                        <p id="modalGender">-</p>
                    </div>
                    <div class="info-group">
                        <label>Email</label>
                        <p id="modalEmail">-</p>
                    </div>
                    <div class="info-group">
                        <label>Số điện thoại</label>
                        <p id="modalPhone">-</p>
                    </div>
                    <div class="info-group">
                        <label>Địa chỉ</label>
                        <p id="modalAddress">-</p>
                    </div>
                    <div class="info-group">
                        <label>Trạng thái</label>
                        <p id="modalStatus">-</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; color: #667eea;">📊 Thống kê học tập</h3>
                <div class="attendance-stats">
                    <div class="mini-stat">
                        <h4 id="modalGPA">0</h4>
                        <p>Điểm trung bình</p>
                    </div>
                    <div class="mini-stat">
                        <h4 id="modalAttendance">0%</h4>
                        <p>Tỷ lệ tham dự</p>
                    </div>
                    <div class="mini-stat">
                        <h4 id="modalAbsent">0</h4>
                        <p>Số buổi vắng</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dữ liệu sinh viên từ server
        const students = @Html.Raw(Json.Serialize(ViewBag.Students ?? new List<object>()));

        let filteredStudents = [...students];
        let sortDirection = {};

        function renderTable() {
            const tbody = document.getElementById('studentTableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const classFilter = document.getElementById('classFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredStudents = students.filter(student => {
                const matchSearch = (student.fullName || '').toLowerCase().includes(searchTerm) ||
                                  (student.mssv || '').includes(searchTerm) ||
                                  (student.email || '').toLowerCase().includes(searchTerm);
                const matchClass = !classFilter || (student.allClasses && student.allClasses.includes(classFilter));
                const matchStatus = !statusFilter || (student.status || '') === statusFilter;
                return matchSearch && matchClass && matchStatus;
            });

            tbody.innerHTML = '';

            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #6c757d;">Không tìm thấy sinh viên nào</td></tr>';
                updateStats();
                return;
            }

            filteredStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.onclick = () => showStudentDetail(student);
                row.style.cursor = 'pointer';

                const nameParts = (student.fullName || '').split(' ').filter(n => n.length > 0);
                let initials = '';
                if (nameParts.length > 1) {
                    initials = nameParts[0][0] + nameParts[nameParts.length - 1][0];
                } else if (nameParts.length === 1) {
                    initials = nameParts[0][0];
                }

                const className = student.allClasses && student.allClasses.length > 0 
                    ? student.allClasses[0] 
                    : 'N/A';

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><div class="student-avatar">${initials}</div></td>
                    <td><strong>${student.mssv || 'N/A'}</strong></td>
                    <td>${student.fullName || 'N/A'}</td>
                    <td>${className}</td>
                    <td>${student.email || 'N/A'}</td>
                    <td>${student.phone || 'N/A'}</td>
                    <td><strong>${(student.gpa || 0).toFixed(2)}</strong></td>
                    <td><strong>${(student.attendanceRate || 0).toFixed(1)}%</strong></td>
                    <td>
                        <span class="status-badge ${(student.status || '') === 'Đang học' ? 'status-active' : 'status-inactive'}">
                            ${student.status || 'N/A'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateStats();
        }

        function updateStats() {
            const total = filteredStudents.length;
            const active = filteredStudents.filter(s => (s.status || '') === 'Đang học').length;
            const avgAttendance = total > 0 ?
                Math.round(filteredStudents.reduce((sum, s) => sum + (s.attendanceRate || 0), 0) / total * 10) / 10 : 0;
            const classes = [...new Set(filteredStudents.flatMap(s => s.allClasses || []))].length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('avgAttendance').textContent = avgAttendance + '%';
            document.getElementById('classCount').textContent = classes;
        }

        function showStudentDetail(student) {
            const modal = document.getElementById('studentModal');
            const nameParts = (student.fullName || '').split(' ').filter(n => n.length > 0);
            let initials = '';
            if (nameParts.length > 1) {
                initials = nameParts[0][0] + nameParts[nameParts.length - 1][0];
            } else if (nameParts.length === 1) {
                initials = nameParts[0][0];
            }

            document.getElementById('modalAvatar').textContent = initials;
            document.getElementById('modalMSSV').textContent = student.mssv || '-';
            document.getElementById('modalName').textContent = student.fullName || '-';
            document.getElementById('modalClass').textContent = (student.allClasses && student.allClasses.length > 0) 
                ? student.allClasses.join(', ') 
                : '-';
            document.getElementById('modalDOB').textContent = student.dob || '-';
            document.getElementById('modalGender').textContent = student.gender || '-';
            document.getElementById('modalEmail').textContent = student.email || '-';
            document.getElementById('modalPhone').textContent = student.phone || '-';
            document.getElementById('modalAddress').textContent = student.address || '-';
            document.getElementById('modalStatus').innerHTML = `
                <span class="status-badge ${(student.status || '') === 'Đang học' ? 'status-active' : 'status-inactive'}">
                    ${student.status || 'N/A'}
                </span>
            `;
            document.getElementById('modalGPA').textContent = (student.gpa || 0).toFixed(2);
            document.getElementById('modalAttendance').textContent = (student.attendanceRate || 0).toFixed(1) + '%';
            document.getElementById('modalAbsent').textContent = student.totalAbsent || 0;

            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('studentModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                alert('❌ Lỗi: Thư viện XLSX chưa được tải. Vui lòng kiểm tra lại liên kết script.');
                return;
            }

            const data = filteredStudents.map((student, index) => ({
                'STT': index + 1,
                'MSSV': student.mssv || 'N/A',
                'Họ và tên': student.fullName || 'N/A',
                'Lớp': (student.allClasses && student.allClasses.length > 0) ? student.allClasses.join(', ') : 'N/A',
                'Ngày sinh': student.dob || 'N/A',
                'Giới tính': student.gender || 'N/A',
                'Email': student.email || 'N/A',
                'Số điện thoại': student.phone || 'N/A',
                'Địa chỉ': student.address || 'N/A',
                'Điểm TB': student.gpa || 0,
                'Tỷ lệ tham dự (%)': student.attendanceRate || 0,
                'Số buổi vắng': student.totalAbsent || 0,
                'Trạng thái': student.status || 'N/A'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Danh sách sinh viên');

            const fileName = `Danh_sach_sinh_vien_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            alert('✅ Đã xuất file Excel thành công!');
        }

        function sortTable(columnIndex) {
            const direction = sortDirection[columnIndex] || 'asc';

            filteredStudents.sort((a, b) => {
                let aVal, bVal;

                switch(columnIndex) {
                    case 2: aVal = a.mssv; bVal = b.mssv; break;
                    case 3: aVal = a.fullName; bVal = b.fullName; break;
                    case 4: aVal = (a.allClasses && a.allClasses.length > 0) ? a.allClasses[0] : ''; 
                            bVal = (b.allClasses && b.allClasses.length > 0) ? b.allClasses[0] : ''; 
                            break;
                    case 7: aVal = a.gpa || 0; bVal = b.gpa || 0; break;
                    case 8: aVal = a.attendanceRate || 0; bVal = b.attendanceRate || 0; break;
                    default: return 0;
                }

                if (aVal === undefined || aVal === null) aVal = '';
                if (bVal === undefined || bVal === null) bVal = '';

                let cmp = 0;
                const isNumber = typeof aVal === 'number' && typeof bVal === 'number';
                if (isNumber) {
                    cmp = aVal - bVal;
                } else {
                    cmp = String(aVal).toLowerCase().localeCompare(String(bVal).toLowerCase());
                }

                return direction === 'asc' ? cmp : -cmp;
            });

            sortDirection[columnIndex] = direction === 'asc' ? 'desc' : 'asc';
            renderTable();
        }

        // Wire up search/filter events
        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('classFilter').addEventListener('change', renderTable);
        document.getElementById('statusFilter').addEventListener('change', renderTable);

        // Initial render
        renderTable();
    </script>
</div>
