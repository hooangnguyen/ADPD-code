@{
    var isPartial = ViewData["IsPartial"] as bool? ?? false;
    Layout = isPartial ? null : "~/Views/Shared/_Layout.cshtml";
}
<link href="~/css/StudentAttendance.css?v=1.0" rel="stylesheet" asp-append-version="true" />

<div class="student-attendance-wrapper">
    <div class="container">
        <div class="header">
            <h1>
                <span style="font-size: 36px;">üìã</span>
                Attendance History
            </h1>
            <p>View your attendance history by course</p>
        </div>

        <div class="toolbar">
            <div class="filter-group">
                <label for="courseSelect">Select course:</label>
                <select id="courseSelect" class="filter-select">
                    <option value="">-- Select course --</option>
                    @if (ViewBag.Courses != null)
                    {
                        @foreach (var course in ViewBag.Courses)
                        {
                            <option value="@course.CourseID">@course.CourseName</option>
                        }
                    }
                </select>
            </div>

            <div class="filter-group">
                <label for="startDate">From date:</label>
                <input type="date" id="startDate" class="filter-select" />
            </div>

            <div class="filter-group">
                <label for="endDate">To date:</label>
                <input type="date" id="endDate" class="filter-select" />
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="loadAttendanceBtn" onclick="loadAttendance()">
                    <span>üîç</span>
                    <span>Search</span>
                </button>
            </div>
        </div>

        <div id="courseInfo" class="course-info" style="display: none;">
            <h3>
                <span>üìö</span>
                <span id="courseNameDisplay"></span>
            </h3>
        </div>

        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card stat-total">
                <div class="stat-icon">üìä</div>
                <h3 id="totalDays">0</h3>
                <p>Total Sessions</p>
            </div>
            <div class="stat-card stat-present">
                <div class="stat-icon">‚úÖ</div>
                <h3 id="presentDays">0</h3>
                <p>Present</p>
            </div>
            <div class="stat-card stat-absent">
                <div class="stat-icon">‚ùå</div>
                <h3 id="absentDays">0</h3>
                <p>Absent</p>
            </div>
            <div class="stat-card stat-excused">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <h3 id="excusedDays">0</h3>
                <p>Excused</p>
            </div>
            <div class="stat-card stat-rate">
                <div class="stat-icon">üìà</div>
                <h3 id="attendanceRate">0%</h3>
                <p>Attendance Rate</p>
            </div>
        </div>

        <div class="table-container" id="attendanceTableContainer" style="display: none;">
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                </tbody>
            </table>
        </div>

        <div id="noDataMessage" class="no-data-message" style="display: none;">
            <p>Please select a course and click "Search" to view attendance history.</p>
        </div>
    </div>
</div>

<script>
    function loadAttendance() {
        const courseId = document.getElementById('courseSelect').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!courseId) {
            alert('Please select a course!');
            return;
        }

        const loadBtn = document.getElementById('loadAttendanceBtn');
        const originalText = loadBtn.innerHTML;
        loadBtn.innerHTML = '<span class="loading"></span> Loading...';
        loadBtn.disabled = true;

        let url = `/Student/GetMyAttendance?courseId=${courseId}`;
        if (startDate) url += `&startDate=${startDate}`;
        if (endDate) url += `&endDate=${endDate}`;

        document.getElementById('attendanceTableBody').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px;"><div class="loading" style="margin: 0 auto;"></div><p style="margin-top: 15px; color: #6c757d;">Loading data...</p></td></tr>';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;

                if (data.success) {
                    displayAttendance(data);
                    document.getElementById('courseNameDisplay').textContent = data.courseName;
                    document.getElementById('courseInfo').style.display = 'flex';
                    document.getElementById('attendanceTableContainer').style.display = 'block';
                    document.getElementById('statsGrid').style.display = 'grid';
                    document.getElementById('noDataMessage').style.display = 'none';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
                console.error('Error:', error);
                alert('An error occurred while loading data!');
            });
    }

    function displayAttendance(data) {
        const stats = data.statistics;
        
        // Update statistics
        document.getElementById('totalDays').textContent = stats.totalDays;
        document.getElementById('presentDays').textContent = stats.presentDays;
        document.getElementById('absentDays').textContent = stats.absentDays;
        document.getElementById('excusedDays').textContent = stats.excusedDays;
        document.getElementById('attendanceRate').textContent = stats.attendanceRate + '%';

        // Display table
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';

        if (data.history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: #6c757d;">No attendance data available</td></tr>';
            return;
        }

        data.history.forEach((record, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${record.dateDisplay}</strong></td>
                <td>
                    <span class="status-badge status-${getStatusClass(record.status)}">
                        ${record.status}
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'C√≥ m·∫∑t': return 'present';
            case 'V·∫Øng': return 'absent';
            case 'C√≥ ph√©p': return 'excused';
            default: return 'pending';
        }
    }
</script>

