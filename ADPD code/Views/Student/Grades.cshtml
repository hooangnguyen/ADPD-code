@model IEnumerable<ADPD_code.Models.Enrollment>
@{
    ViewData["Title"] = "Grades";
    var isPartial = ViewData["IsPartial"] as bool? ?? false;
    Layout = isPartial ? null : "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/Dashboard.css" />
    <div class="grades-header">
        <h1>ðŸ“Š Grades</h1>
        <p>Student academic results</p>
    </div>

    @if (Model != null && Model.Any())
    {
        // Group by Academic Year and Semester
        var groupedGrades = Model
        .GroupBy(e => new { e.AcademicYear, e.Semester })
        .OrderByDescending(g => g.Key.AcademicYear)
        .ThenByDescending(g => g.Key.Semester);

        @foreach (var semesterGroup in groupedGrades)
        {
            var grades = semesterGroup.ToList();

            // Calculate semester GPA
            var semesterScores = grades
            .Where(e => !string.IsNullOrEmpty(e.Score?.ToString()) && double.TryParse(e.Score?.ToString(), out _))
            .Select(e => double.Parse(e.Score?.ToString() ?? "0"))
            .ToList();

            double semesterGPA = semesterScores.Any() ? Math.Round(semesterScores.Average(), 2) : 0;
            int semesterCredits = grades
            .Where(e => e.Course != null)
            .Sum(e => e.Course!.Credits);

            <div class="semester-group">
                <div class="semester-title">
                    @semesterGroup.Key.Semester - Academic Year @semesterGroup.Key.AcademicYear
                </div>

                <table class="grades-table">
                    <thead>
                        <tr>
                            <th>Course Code</th>
                            <th>Course Name</th>
                            <th>Credits</th>
                            <th>Lecturer</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var enrollment in grades)
                        {
                            var score = 0.0;
                            var hasScore = double.TryParse(enrollment.Score?.ToString(), out score);

                            var scoreClass = score >= 8.5 ? "score-excellent" :
                            score >= 7.0 ? "score-good" :
                            score >= 5.5 ? "score-average" : "score-poor";

                            <tr>
                                <td><strong>CS@(enrollment.CourseID)</strong></td>
                                <td>@(enrollment.Course?.CourseName ?? "N/A")</td>
                                <td>@(enrollment.Course != null ? enrollment.Course.Credits.ToString() : "0")</td>
                                <td>@(enrollment.Course?.Lecturer?.FullName ?? "N/A")</td>
                                <td>
                                    @if (hasScore)
                                    {
                                        <span class="score-badge @scoreClass">@score</span>
                                    }
                                    else
                                    {
                                        <span style="color: #999;">No score yet</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="gpa-summary">
                    <div class="gpa-item">
                        <h3>Semester GPA</h3>
                        <div class="value">@semesterGPA</div>
                    </div>
                    <div class="gpa-item">
                        <h3>Credits Completed</h3>
                        <div class="value">@semesterCredits</div>
                    </div>
                    <div class="gpa-item">
                        <h3>Number of Courses</h3>
                        <div class="value">@grades.Count</div>
                    </div>
                </div>
            </div>
        }

        // Summary
        var totalScores = Model
        .Where(e => !string.IsNullOrEmpty(e.Score?.ToString()) && double.TryParse(e.Score?.ToString(), out _))
        .Select(e => double.Parse(e.Score?.ToString() ?? "0"))
        .ToList();

        double overallGPA = totalScores.Any() ? Math.Round(totalScores.Average(), 2) : 0;
        int totalCredits = Model.Where(e => e.Course != null)
        // Assuming Credits is INT/DOUBLE type, just SUM directly
        .Sum(e => e.Course!.Credits);

        <div class="semester-group" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
                ðŸ“ˆ Summary
            </div>
            <div class="gpa-summary" style="background: rgba(255,255,255,0.1);">
                <div class="gpa-item" style="color: white;">
                    <h3 style="color: rgba(255,255,255,0.8);">Cumulative GPA</h3>
                    <div class="value" style="color: white; font-size: 32px;">@overallGPA</div>
                </div>
                <div class="gpa-item" style="color: white;">
                    <h3 style="color: rgba(255,255,255,0.8);">Total Credits</h3>
                    <div class="value" style="color: white; font-size: 32px;">@totalCredits</div>
                </div>
                <div class="gpa-item" style="color: white;">
                    <h3 style="color: rgba(255,255,255,0.8);">Total Courses</h3>
                    <div class="value" style="color: white; font-size: 32px;">@Model.Count()</div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="semester-group">
            <div class="no-data">
                <h3>ðŸ“š No grade data available</h3>
                <p>You haven't registered for any courses or don't have grades yet.</p>
            </div>
        </div>
    }
