@model IEnumerable<ADPD_code.Models.Course>
@{
    ViewData["Title"] = "Course Registration";
    var isPartial = ViewData["IsPartial"] as bool? ?? false;
    Layout = isPartial ? null : "~/Views/Shared/_Layout.cshtml";
    var registeredCourseIds = ViewBag.RegisteredCourseIds as List<int> ?? new List<int>();
    var currentSemester = ViewBag.CurrentSemester as string ?? "HK1";
    var currentYear = ViewBag.CurrentAcademicYear as string ?? "2024-2025";
}

<link rel="stylesheet" href="~/css/RegisterStudy.css" />

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            <span>‚úì</span>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-error">
            <span>‚ö†</span>
            <span>@TempData["ErrorMessage"]</span>
        </div>
    }

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">üìö Course Registration</div>
        <div class="semester-info">
            Semester: @currentSemester | Academic Year: @currentYear
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-number" id="totalCourses">@Model.Count()</div>
            <div class="summary-label">Available Courses</div>
        </div>
        <div class="summary-card">
            <div class="summary-number" id="registeredCount">@registeredCourseIds.Count</div>
            <div class="summary-label">Registered</div>
        </div>
        <div class="summary-card">
            <div class="summary-number" id="totalCredits">
                @Model.Where(c => registeredCourseIds.Contains(c.CourseID)).Sum(c => c.Credits)
            </div>
            <div class="summary-label">Total Credits</div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="get" action="@Url.Action("RegisterStudy", "Student")" id="filterForm">
            <input type="hidden" name="partial" value="@(isPartial ? "true" : "false")" />
            <div class="filter-grid">
                <div class="filter-item">
                    <label class="filter-label">Search courses</label>
                    <input type="text" name="search" class="filter-input"
                           placeholder="Enter course name..."
                           value="@Context.Request.Query["search"]">
                </div>
                <div class="filter-item">
                    <label class="filter-label">Credits</label>
                    <select name="credits" class="filter-select">
                        <option value="">All</option>
                        <option value="2" selected="@(Context.Request.Query["credits"] == "2")">2 credits</option>
                        <option value="3" selected="@(Context.Request.Query["credits"] == "3")">3 credits</option>
                        <option value="4" selected="@(Context.Request.Query["credits"] == "4")">4 credits</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label class="filter-label">Lecturer</label>
                    <input type="text" name="lecturer" class="filter-input"
                           placeholder="Lecturer name..."
                           value="@Context.Request.Query["lecturer"]">
                </div>
                <div class="filter-item">
                    <button type="submit" class="btn-filter">üîç Search</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Course Table -->
    <div class="course-table-container">
        @if (Model != null && Model.Any())
        {
            <table class="course-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Course</th>
                        <th style="width: 20%;">Lecturer</th>
                        <th style="width: 10%; text-align: center;">Credits</th>
                        <th style="width: 15%; text-align: center;">Available Seats</th>
                        <th style="width: 25%; text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var course in Model)
                    {
                        var isRegistered = registeredCourseIds.Contains(course.CourseID);
                        var enrolledCount = course.Enrollments?.Count ?? 0;
                        var maxStudents = 50; // Maximum students per class
                        var availableSeats = maxStudents - enrolledCount;
                        var isFull = availableSeats <= 0;

                        <tr>
                            <td>
                                <div class="course-name">@course.CourseName</div>
                                <div class="course-code">Code: MH @course.CourseID.ToString().PadLeft(4, '0')</div>
                            </td>
                            <td>
                                <div class="lecturer-name">
                                    @(course.Lecturer?.FullName ?? "Not assigned")
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <span class="credits-badge">@course.Credits Credits</span>
                            </td>
                            <td style="text-align: center;">
                                <div class="seats-info">
                                    @if (isFull)
                                    {
                                        <span class="seats-full" style="color: #e74c3c; font-weight: 600;">
                                            Full
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="seats-available" style="color: #27ae60; font-weight: 600;">
                                            @availableSeats seats left
                                        </span>
                                    }
                                </div>
                            </td>
                            <td style="text-align: right;">
                                @if (isRegistered)
                                {
                                    <span class="status-registered">
                                        <span>‚úì</span>
                                        <span>Registered</span>
                                    </span>
                                }
                                else if (isFull)
                                {
                                    <button class="btn-register" disabled style="background: #95a5a6; cursor: not-allowed; opacity: 0.6;">
                                        ‚ùå Full
                                    </button>
                                }
                                else
                                {
                                    <form method="post" action="@Url.Action("RegisterCourse", "Student")" style="display: inline;" onsubmit="return confirm('Are you sure you want to register for this course?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="courseId" value="@course.CourseID" />
                                        <input type="hidden" name="semester" value="@currentSemester" />
                                        <input type="hidden" name="academicYear" value="@currentYear" />
                                        <input type="hidden" name="partial" value="@(isPartial ? "true" : "false")" />
                                        <button type="submit" class="btn-register">
                                            ‚ûï Register
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">üìö</div>
                <p style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No courses available</p>
                <p>Please try again with different filters</p>
            </div>
        }
    </div>
</div>